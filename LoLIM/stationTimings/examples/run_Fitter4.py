#!/usr/bin/env python3

###TODO: order output of stations
### FIX error matrix
### try cross-corelations
### potetnail: output list of all used antenans per source per station. o, for each antenna, give contributing events
## output num measurments for each antenna in antennas_to_recallibrate
### then try recalibrating ALL antennas!

## these lines are anachronistic and should be fixed at some point
from LoLIM import utilities
utilities.default_raw_data_loc = "/home/brian/KAP_data_link/lightning_data"
utilities.default_processed_data_loc = "/home/brian/processed_files"

## I AM HERE. TRYING TO ADD SOURCE 110, then improve fitter as above

#refractivity = 0.000293*2
#utilities.v_air = utilities.C/(1.0+refractivity)

from LoLIM.stationTimings.timingFitter_4_polt import run_fitter   


guess_timings = {

#'CS001' : 2.227690954908188e-06 , ## diff to guess: -5.055940165857531e-10
#'CS003' : 1.4047026084435414e-06 , ## diff to guess: 3.334676246986376e-10
#'CS004' : 4.31045422642375e-07 , ## diff to guess: -1.4534929813746668e-10
#'CS005' : -2.192756312580944e-07 , ## diff to guess: -2.0269129683402354e-10
#'CS006' : 4.3384155379347055e-07 , ## diff to guess: -1.261711710604433e-10
#'CS007' : 4.006988055220884e-07 , ## diff to guess: -6.951947825087132e-11
#'CS011' : -5.851982493845184e-07 , ## diff to guess: -5.356366087653606e-10
#'CS013' : -1.8142605367741052e-06 , ## diff to guess: 1.1904981905183887e-09
#'CS017' : -8.439211449521343e-06 , ## diff to guess: -5.053956606632727e-10
#'CS021' : 9.24194146269567e-07 , ## diff to guess: 1.3540313549679038e-09
#'CS024' : 2.321299308642149e-06 , ## diff to guess: -1.7632435014273006e-09
#'CS026' : -9.234735248221191e-06 , ## diff to guess: -1.0551159334715995e-09
#'CS028' : -9.983137825072292e-06 , ## diff to guess: 2.3024137996797083e-09
#'CS030' : -2.7437820047360744e-06 , ## diff to guess: 2.054963837349401e-09
#'CS032' : -1.573834773941896e-06 , ## diff to guess: 2.452606209876767e-10
#'CS103' : -2.8519733738209974e-05 , ## diff to guess: -2.185477255879653e-09
#'CS201' : -1.0485080305542828e-05 , ## diff to guess: -1.5813198998613451e-09
#'CS301' : -7.181891898714131e-07 , ## diff to guess: -1.468587080491088e-09
#'CS302' : -5.35256530211369e-06 , ## diff to guess: -1.0316167703917011e-09
#'CS401' : -9.516904225426516e-07 , ## diff to guess: 1.1512314068193357e-09
#'CS501' : -9.611335177991273e-06 , ## diff to guess: 2.8308622105797324e-09
#'RS106' : 7.010774363855206e-06 , ## diff to guess: -1.5669925614877072e-08
#'RS205' : 7.002515986325957e-06 , ## diff to guess: -7.946335232219596e-09
#'RS208' : 6.987902360719413e-06 , ## diff to guess: -1.8989442591204196e-08
#'RS306' : 7.024585972232264e-06 , ## diff to guess: 3.912125572606044e-09
#'RS307' : 6.9581291514877714e-06 , ## diff to guess: 1.3814733192408357e-08
#'RS310' : 6.983844098497767e-06 , ## diff to guess: 3.113672315196525e-08
#'RS406' : 6.960184913538271e-06 , ## diff to guess: 1.0856534160316503e-08
#'RS407' : 7.031352852572595e-06 , ## diff to guess: 8.041597551453793e-09
#'RS409' : 6.893601566207483e-06 , ## diff to guess: 3.071146685199345e-08
#'RS503' : 6.945556560911467e-06 , ## diff to guess: 2.025971870287835e-09
#'RS508' : 6.980746897687676e-06 , ## diff to guess: -7.881187239501113e-10
#'RS210' : 7.018096145318694e-06 , ## diff to guess: -1.0034337307704719e-07
#'RS305' : 6.916389042335617e-06 , ## diff to guess: 4.7330120100382245e-09

        
        
        
#'CS001' : 2.227642093323077e-06 , ## diff to guess: 4.8068616788517465e-12
#'CS003' : 1.404675263350784e-06 , ## diff to guess: -7.44079819354629e-12
#'CS004' : 4.3086679881973887e-07 , ## diff to guess: -3.3081035157201346e-12
#'CS005' : -2.1923827738510924e-07 , ## diff to guess: 5.298339416585399e-12
#'CS006' : 4.338519762890058e-07 , ## diff to guess: 5.068088362702927e-12
#'CS007' : 4.00547477232669e-07 , ## diff to guess: 1.4849235245585591e-12
#'CS011' : -5.852961583724501e-07 , ## diff to guess: 1.642388605211963e-11
#'CS013' : -1.8142107837483322e-06 , ## diff to guess: -2.432153883474241e-11
#'CS017' : -8.439393657718044e-06 , ## diff to guess: 1.7367882063689462e-11
#'CS021' : 9.239875529571105e-07 , ## diff to guess: -3.790245839681917e-11
#'CS024' : 2.321218501208334e-06 , ## diff to guess: 3.40065543270613e-11
#'CS026' : -9.234991288716451e-06 , ## diff to guess: 3.0348066058801903e-11
#'CS028' : -9.983323362157984e-06 , ## diff to guess: -3.120486934983773e-11
#'CS030' : -2.743926317467117e-06 , ## diff to guess: -4.8489320825192045e-11
#'CS032' : -1.5738616425100155e-06 , ## diff to guess: -2.0495129765148225e-11
#'CS103' : -2.8519814193742614e-05 , ## diff to guess: 6.954696440256473e-11
#'CS201' : -1.0485152113372998e-05 , ## diff to guess: 4.331357976514042e-11
#'CS301' : -7.182703351717477e-07 , ## diff to guess: 2.046946673868901e-11
#'CS302' : -5.35261487838274e-06 , ## diff to guess: -1.4166480181213557e-11
#'CS401' : -9.517513083736555e-07 , ## diff to guess: -4.525189911926173e-11
#'CS501' : -9.611279494372421e-06 , ## diff to guess: -6.13366068937508e-11
#'RS106' : 7.01094237718933e-06 , ## diff to guess: 3.943837317641342e-10
#'RS205' : 7.0023717853258245e-06 , ## diff to guess: -1.911343958234076e-10
#'RS208' : 6.987540689254793e-06 , ## diff to guess: 1.0779860102569936e-10
#'RS306' : 7.024799691720886e-06 , ## diff to guess: -1.1718715345525543e-10
#'RS307' : 6.957958918403147e-06 , ## diff to guess: -4.3806332339605157e-10
#'RS310' : 6.9849327988687056e-06 , ## diff to guess: -1.0589022497858587e-09
#'RS406' : 6.960263301406842e-06 , ## diff to guess: -3.32219864885761e-11
#'RS407' : 7.031012357077462e-06 , ## diff to guess: -7.948890030065923e-11
#'RS409' : 6.894171418674786e-06 , ## diff to guess: -7.589665299957904e-10
#'RS503' : 6.9454667742525215e-06 , ## diff to guess: -3.092496519229408e-11
#'RS508' : 6.9801311677961334e-06 , ## diff to guess: 2.0164040452645335e-10
#'RS210' : 7.017433361782676e-06 , ## diff to guess: 2.7025937395109824e-10
#'RS305' : 6.9157246400472815e-06 , ## diff to guess: -2.454616065620583e-10

'CS001' : 2.2276308572702324e-06 , ## diff to guess: -2.9509864748005995e-13
'CS003' : 1.4046383546190539e-06 , ## diff to guess: -2.1219604133541805e-12
'CS004' : 4.308109046846056e-07 , ## diff to guess: -1.1252724883861337e-12
'CS005' : -2.193146826000691e-07 , ## diff to guess: -9.226373561973865e-13
'CS006' : 4.3380133647927444e-07 , ## diff to guess: 9.20361212596717e-14
'CS007' : 4.0048250568923026e-07 , ## diff to guess: -8.109796235409447e-13
'CS011' : -5.853090467386582e-07 , ## diff to guess: 2.2687461653737436e-12
'CS013' : -1.8143052721107756e-06 , ## diff to guess: -4.387157458480523e-12
'CS017' : -8.439514416935955e-06 , ## diff to guess: 2.4066774625025903e-12
'CS021' : 9.23955994545318e-07 , ## diff to guess: -6.6658727112113735e-12
'CS024' : 2.321223934872172e-06 , ## diff to guess: 4.41583587839801e-12
'CS026' : -9.235076475636667e-06 , ## diff to guess: 4.316867074579973e-12
'CS028' : -9.983505457320307e-06 , ## diff to guess: -4.1074391151897866e-12
'CS030' : -2.7440872271955016e-06 , ## diff to guess: -9.641659714714021e-12
'CS032' : -1.5739274807434387e-06 , ## diff to guess: -4.7397160460106215e-12
'CS103' : -2.851994779258623e-05 , ## diff to guess: 1.2076021192947758e-11
'CS201' : -1.0485203520999106e-05 , ## diff to guess: 6.407962864756617e-12
'CS301' : -7.180768530462705e-07 , ## diff to guess: 8.336292191384053e-12
'CS302' : -5.3524812545793426e-06 , ## diff to guess: -4.362871029755426e-12
'CS401' : -9.51897612529647e-07 , ## diff to guess: -8.421119931660699e-12
'CS501' : -9.611494501753068e-06 , ## diff to guess: -9.54180481914195e-12
'RS106' : 7.010379768369342e-06 , ## diff to guess: 7.769372037831477e-11
'RS205' : 7.002255454892007e-06 , ## diff to guess: 4.850975157709366e-11
'RS208' : 6.987479381143302e-06 , ## diff to guess: 2.411776675502545e-10
'RS306' : 7.025076697694534e-06 , ## diff to guess: 6.13943767557447e-11
'RS307' : 6.9585245454233e-06 , ## diff to guess: -8.117783325766966e-11
'RS310' : 6.986490973692681e-06 , ## diff to guess: -2.6024030325007784e-10
'RS406' : 6.9603817338604466e-06 , ## diff to guess: -1.2812793862290804e-10
'RS407' : 7.031000140489527e-06 , ## diff to guess: -1.1633651972774368e-10
'RS409' : 6.895300791310811e-06 , ## diff to guess: -1.8611853370641108e-10
'RS503' : 6.945421181756787e-06 , ## diff to guess: -2.7672002500024346e-11
'RS508' : 6.979718934359202e-06 , ## diff to guess: -9.61972873989966e-11
'RS210' : 7.017414336610824e-06 , ## diff to guess: 3.1513711062248356e-10
'RS305' : 6.916123476067248e-06 , ## diff to guess: 2.91950343176713e-11



        }

#known_sources = [0, 10, 20, 30, 60, 70, 80, 90]
known_sources = [0, 10, 20, 30, 70, 80, 90]

### locations of fitted sources
guess_source_locations = {

#0 :[ 20860.905516875784 , -71740.96427235217 , 4733.993408147181 , 1.2359578360120873 ,
#    20869.911682664893 , -71753.88874046867 , 4726.278835298423 , 1.235957797058452 ],
#10 :[ 20849.34627128251 , -71893.50122647239 , 4817.552044847145 , 1.232748732542268 , 1.2327487234052867 ],
#20 :[ 20864.100789213757 , -71927.26015794018 , 4721.840905169466 , 1.2337271827536629 ,
#    20869.402852064915 , -71928.87563201373 , 4700.781198465302 , 1.2337271760921253 ],
#30 :[ 21632.629559615663 , -71963.54489996795 , 6997.049814984212 , 1.2479025181678054 ],
#60 :[ 23052.069956022187 , -71952.90516489907 , 9613.836911624523 , 1.4330059794505583 ],
#70 :[ -29699.65541108287 , -6084.294506989308 , 4948.1977164546015 , 1.4433568243704187 ],
#80 :[ -30330.756764235146 , -8645.975853684558 , 3551.3547971038074 , 1.4471758544967894 ,
#    -30333.023728997032 , -8642.205360485024 , 3552.990283789833 , 1.447175851653836 ],
#90 :[ -29354.233108493052 , -5855.5364039523865 , 5280.619511171185 , 1.4495679148638185 ],
#110 :[ -29501.94104683349 , -5799.314527516485 , 5303.359062718574 , 1.4508841855577546 ],

        
        
        
#0 :[ 20869.4534624676 , -71753.76130797164 , 4727.950521014093 , 1.2359577976707583 ],
#10 :[ 20850.076908750252 , -71894.90450190268 , 4822.159661333505 , 1.2327487264574117 ],
#20 :[ 20869.83304782404 , -71930.54117896008 , 4695.875572621992 , 1.2337271715141953 ],
#30 :[ 21631.815734584427 , -71963.06351707825 , 6998.261527872335 , 1.2479025202265608 ],
#60 :[ 23051.325901884058 , -71952.50804973244 , 9614.802262440937 , 1.433005981175886 ],
#70 :[ -29699.710081581725 , -6084.418958624342 , 4946.433472397333 , 1.443356825133301 ],
#80 :[ -30333.082444343425 , -8642.453656554777 , 3552.2659755994755 , 1.447175851616874 ],
#90 :[ -29353.969637063867 , -5855.542744107529 , 5280.475603400792 , 1.4495679158744446 ],

0 :[ 20868.381346321923 , -71752.88591015663 , 4729.1503415246125 , 1.235957801281892 ],
10 :[ 20848.99514534114 , -71894.650004386 , 4825.533423939511 , 1.2327487276100546 ],
20 :[ 20868.854822204055 , -71930.58362368635 , 4698.950906439899 , 1.2337271717185163 ],
30 :[ 21630.656063919967 , -71962.7641801605 , 7000.7917239592825 , 1.2479025215701154 ],
60 :[ 23050.093433524093 , -71952.18972465595 , 9616.851405101814 , 1.433005982645372 ],
70 :[ -29699.93619564593 , -6084.397201033842 , 4944.182146653781 , 1.4433568257316336 ],
80 :[ -30333.268408315987 , -8642.513280951076 , 3550.3062737618966 , 1.4471758517729654 ],
90 :[ -29354.17798611013 , -5855.539174257314 , 5278.827186188502 , 1.4495679162216204 ],

}

### polarization of fitted sources
# 0 is even, 1 is odd, 2 is both with different 3, 3 is both with different xyztknown_polarizations = {

known_polarizations = {
#0  : 3 ,
#10 : 2 ,
#20 : 3 ,
#30 : 0 , ## no intensity in odd pol
#60 : 0, ## odd pulse is wierd 
#70 : 0, ## odd pulse is very complex
#80 : 3,
#90 : 0, ## odd pulse is very complex
#110 : 1, 
#}
0  : 1 ,
10 : 0,
20 : 1 ,
30 : 0 , ## no intensity in odd pol
60 : 0, ## odd pulse is wierd 
70 : 0, ## odd pulse is very complex
80 : 1,
90 : 0, ## odd pulse is very complex
}
    
#0. 2,1    

## these are stations to exclude
stations_to_exclude = {
        0: ['RS406'], #RS406 has complex shape  'RS409', 'RS210', 'RS305' do not seem compatible with even and odd from 1 loc
        10: [],
        20: [],
        30: [],
        60: [],
        70: [ 'CS001', 'RS409' ],#CS001 saturation#, RS409 has big issues here
        80: ['RS208', 'RS210', 'RS307'], ##odd has too complex shape
        90: [ 'RS409'], ## RS409 is wrong. No idea why.
        }
## 

##CS301 may have problems

antennas_to_exclude = {
        0: ['130001015' ],
        10: [],
        20: [ '183011094'],
        30: [],
        60: [],
        70: ['021005046', '024007062', '024009078', '142005046', '142009078', '142011094', '125001014',
             '146003030', '146011094', '146007062', '147001014', '147005047', '147011094', '147011095',
             '145009078'],
        80: ['146001014', '146003030', '146011094', '147003030', '147005046', '147007062', '147007063', 
             '147003031', '169003031', '169003030', '169005046', '169005047', '169007062'],
        90: ['18107061', '181009078',  '128001015', '128005047', '128007063', '128009079', '150001014',
             '150007062'],
        }


#TODO: print number of data points used for each recalibrated antenna
antennas_to_recallibrate = {

#'028005046' :  6.462616450500239e-09 , # CS028
#'028005047' :  7.147874986274712e-09 , # CS028
#'141007063' :  -5.021692586123664e-09 , # CS301
#'146001015' :  -4.275976342976383e-09 , # RS306
#'146007062' :  1.5540096810436692e-09 , # RS306
#'166001014' :  3.215695703876139e-10 , # RS406
#'166003031' :  2.6870961781718683e-09 , # RS406
#'169005046' :  -8.775891277114729e-09 , # RS409
#'169005047' :  -6.811370309619433e-09 , # RS409
#'169009079' :  2.0359210519596062e-09 , # RS409
#'145007062' :  1.0840998365838459e-08 , # RS305
#'145007063' :  1.0497102376513198e-08 , # RS305

#'028005046' :  6.508926860048341e-09 , # CS028
#'028005047' :  6.959976046291854e-09 , # CS028
#'141007063' :  -4.980424523803834e-09 , # CS301
##'146001015' :  -5.707688448193284e-10 , # RS306
#'146007062' :  9.947526008991922e-10 , # RS306
#'166001014' :  2.075441537687021e-10 , # RS406
#'166003031' :  -4.719902045359653e-10 , # RS406
#'169005046' :  -8.754446319141919e-09 , # RS409
#'169005047' :  -7.009849615713419e-09 , # RS409
#'169009079' :  5.300622912012122e-10 , # RS409
#'169007062' :  0.0, # RS409
#'145007062' :  1.1529988795844232e-08 , # RS305
#'145007063' :  1.1224900975863703e-08 , # RS305
#'145009079' : 0.0 , # RS305
#'150005047' : 0.0 , ## ?
#'141007062' : 0.0, ##?


'028005046' :  6.589252911192648e-09 , # CS028
'028005047' :  6.872666817785678e-09 , # CS028
'141007062' :  -3.2007566291147212e-09 , # CS301
'141007063' :  -5.1705531723004074e-09 , # CS301
'146007062' :  6.00574664888038e-10 , # RS306
'150005047' :  -3.665663473078959e-09 , # RS310
'166001014' :  -2.4663979560821277e-11 , # RS406
'166003031' :  5.105405739118549e-10 , # RS406
'169005046' :  -8.887009034803927e-09 , # RS409
'169005047' :  -7.533562374903695e-09 , # RS409
'169007062' :  -7.6956183226621e-10 , # RS409
'169009079' :  5.553652623745911e-10 , # RS409
'145007062' :  1.1342280411006793e-08 , # RS305
'145007063' :  1.1024102501530937e-08 , # RS305
'145009079' :  -1.3033577955632049e-09 , # RS305


        }

bad_antennas = [
        ##CS002
        ##CS003
        ##CS004
        ##CS005
        ##CS006
        ##CS007
        ##CS011
        ##CS013
        ##CS017
        ##CS021
        ##CS026
        ##CS028
        ##CS030
        ##CS032
        ##CS101
        ##CS103
        ##CS301
        ##CS302
        ##CS401
        ##CS501
        ##RS106
        ##RS205
        ##RS208
        ##RS305
        ##RS306
        ##RS307
        ##RS310
        ##RS406
        ##RS409 
        ##RS503  
        ##RS508
        ##RS509
                ]

if __name__== "__main__":
    fitter = run_fitter(timeID = "D20180809T141413.250Z", 
                        output_folder = "Callibration_1", 
                        pulse_input_folders = ['pulse_finding'], 
                        guess_timings = guess_timings, 
                        sources_to_fit = known_sources, ## NOTE: that the index here is file_index + source_index*10 
                        guess_source_locations = guess_source_locations,
                   source_polarizations = known_polarizations, ## NOTE: 0 is even, 1 is odd, 2 is both
                   source_stations_to_exclude = stations_to_exclude, 
                   source_antennas_to_exclude = antennas_to_exclude, 
                   bad_ants = bad_antennas,
                   antennas_to_recalibrate = antennas_to_recallibrate,
                   min_ant_amplitude = 10,
                   ref_station = "CS002")
    
    fitter.setup()
    fitter.fit( 4, 4, randomness = 10.0E-9, ant_randomness = 0.5e-9)
    print()
    fitter.print_cov_diag()
    
    
    
    
    
    
    
    
    